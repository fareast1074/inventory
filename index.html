<script>
let inventory = JSON.parse(localStorage.getItem("inventory")) || [];
renderList();

let scanning = false;
let stream;

async function startScanner() {

    if (!('BarcodeDetector' in window)) {
        alert("Your browser does not support BarcodeDetector. Use Chrome.");
        return;
    }

    if (scanning) return;
    scanning = true;

    const barcodeDetector = new BarcodeDetector({
        formats: ['ean_13','ean_8','code_128','upc_a','upc_e']
    });

    stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
    });

    const video = document.createElement("video");
    video.srcObject = stream;
    video.setAttribute("playsinline", true);
    video.play();

    document.getElementById("scanner").innerHTML = "";
    document.getElementById("scanner").appendChild(video);

    const scanLoop = async () => {
        if (!scanning) return;

        const barcodes = await barcodeDetector.detect(video);
        if (barcodes.length > 0) {
            barcode.value = barcodes[0].rawValue;
            stopScanner();
            return;
        }
        requestAnimationFrame(scanLoop);
    };

    scanLoop();
}

function stopScanner() {
    scanning = false;
    if (stream) stream.getTracks().forEach(t => t.stop());
}

function saveItem() {
    inventory.push({
        barcode: barcode.value,
        name: name.value,
        qty: qty.value,
        date: new Date().toLocaleString()
    });
    localStorage.setItem("inventory", JSON.stringify(inventory));
    renderList();
    barcode.value = name.value = qty.value = "";
}

function renderList() {
    let html = "";
    inventory.forEach(i => {
        html += `
        <div class="list-item">
            <div>
                <div>${i.name || "Unnamed"}</div>
                <small>${i.barcode}</small>
            </div>
            <div class="qty">x${i.qty}</div>
        </div>`;
    });
    list.innerHTML = html;
}
</script>
